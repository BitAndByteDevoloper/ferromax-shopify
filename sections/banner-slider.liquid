{% comment %}
  Archivo: sections/banner-slider.liquid
  Sección de Banner Slider Adaptable para Dawn Theme
{% endcomment %}

{{ 'section-banner-slider.css' | asset_url | stylesheet_tag }}

<div class="banner-slider-section page-width-{{ section.settings.page_width }}">
  <!-- Contenedor para Móvil -->
  <div class="body-movil-banner-principal" data-autoplay="{{ section.settings.autoplay }}" data-autoplay-speed="{{ section.settings.autoplay_speed }}">
    <div class="slider-container-banner-principal-movil">
      <div class="slider-banner-principal-movil" id="slider-banner-principal-movil-{{ section.id }}">
        {% for block in section.blocks %}
          {% if block.settings.image_mobile %}
            <div class="slide-banner-principal-movil" {{ block.shopify_attributes }}>
              {% if block.settings.link != blank %}
                <a href="{{ block.settings.link }}" {% if block.settings.open_new_tab %}target="_blank"{% endif %}>
              {% endif %}
                {{ block.settings.image_mobile | image_url: width: 800 | image_tag: 
                  alt: block.settings.image_mobile.alt | default: 'Banner móvil',
                  loading: 'lazy',
                  class: 'banner-image-mobile'
                }}
              {% if block.settings.link != blank %}
                </a>
              {% endif %}
            </div>
          {% endif %}
        {% endfor %}
      </div>
      
      <!-- Controles para Móvil -->
      <div class="controls-banner-principal-movil">
        <button class="icon-button-banner-principal-movil" id="prev-banner-principal-movil-{{ section.id }}" aria-label="Anterior">
          <svg width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M6 1L2 5L6 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        
        {% for block in section.blocks %}
          {% if block.settings.image_mobile %}
            <button class="control-button-banner-principal-movil" data-slide="{{ forloop.index0 }}" aria-label="Ir a slide {{ forloop.index }}"></button>
          {% endif %}
        {% endfor %}
        
        <button class="icon-button-banner-principal-movil" id="next-banner-principal-movil-{{ section.id }}" aria-label="Siguiente">
          <svg width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M4 1L8 5L4 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        
        <button class="icon-button-banner-principal-movil" id="pause-banner-principal-movil-{{ section.id }}" aria-label="Pausar">
          <svg class="pause-icon" width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="1" y="1" width="3" height="8" fill="currentColor"/>
            <rect x="6" y="1" width="3" height="8" fill="currentColor"/>
          </svg>
          <svg class="play-icon" style="display:none;" width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M2 1L8 5L2 9V1Z" fill="currentColor"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Contenedor para PC y Tablet -->
  <div class="slider-container-banner-principal-body">
    <div class="slider-container-banner-principal">
      <div class="slider-banner-principal" id="slider-banner-principal-{{ section.id }}">
        {% for block in section.blocks %}
          {% if block.settings.image_desktop %}
            <div class="slide-banner-principal" {{ block.shopify_attributes }}>
              {% if block.settings.link != blank %}
                <a href="{{ block.settings.link }}" {% if block.settings.open_new_tab %}target="_blank"{% endif %}>
              {% endif %}
                {{ block.settings.image_desktop | image_url: width: 1400 | image_tag: 
                  alt: block.settings.image_desktop.alt | default: 'Banner',
                  loading: 'lazy',
                  class: 'banner-image-desktop'
                }}
              {% if block.settings.link != blank %}
                </a>
              {% endif %}
            </div>
          {% endif %}
        {% endfor %}
      </div>
      
      <!-- Controles para PC y Tablet -->
      <div class="controls-banner-principal">
        <button class="icon-button-banner-principal" id="prev-banner-principal-{{ section.id }}" aria-label="Anterior">
          <svg width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M6 1L2 5L6 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        
        {% for block in section.blocks %}
          {% if block.settings.image_desktop %}
            <button class="control-button-banner-principal" data-slide="{{ forloop.index0 }}" aria-label="Ir a slide {{ forloop.index }}"></button>
          {% endif %}
        {% endfor %}
        
        <button class="icon-button-banner-principal" id="next-banner-principal-{{ section.id }}" aria-label="Siguiente">
          <svg width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M4 1L8 5L4 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        
        <button class="icon-button-banner-principal" id="pause-banner-principal-{{ section.id }}" aria-label="Pausar">
          <svg class="pause-icon" width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="1" y="1" width="3" height="8" fill="currentColor"/>
            <rect x="6" y="1" width="3" height="8" fill="currentColor"/>
          </svg>
          <svg class="play-icon" style="display:none;" width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M2 1L8 5L2 9V1Z" fill="currentColor"/>
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const sectionId = '{{ section.id }}';
    const autoplay = {{ section.settings.autoplay }};
    const autoplaySpeed = {{ section.settings.autoplay_speed }} * 1000;
    
    // Función para inicializar el slider
    function initSlider(options) {
      const {
        sliderSelector,
        slideSelector,
        controlButtonsSelector,
        prevButtonSelector,
        nextButtonSelector,
        pauseButtonSelector,
        isMobile
      } = options;

      let currentIndex = 0;
      let isPaused = false;
      const slider = document.querySelector(sliderSelector);
      if (!slider) return;
      
      const slides = slider.querySelectorAll(slideSelector);
      const controlButtons = document.querySelectorAll(controlButtonsSelector);
      const prevButton = document.querySelector(prevButtonSelector);
      const nextButton = document.querySelector(nextButtonSelector);
      const pauseButton = document.querySelector(pauseButtonSelector);
      let slideInterval;

      // Actualizar el slider y los botones de control
      function updateSlider() {
        slider.style.transform = `translateX(${-currentIndex * 100}%)`;
        controlButtons.forEach((btn, index) => {
          btn.classList.toggle('active' + (isMobile ? '-movil' : ''), index === currentIndex);
        });
      }

      // Avanzar al siguiente slide
      function nextSlide() {
        if (!isPaused) {
          currentIndex = (currentIndex + 1) % slides.length;
          updateSlider();
        }
      }

      // Retroceder al slide anterior
      function prevSlideFunc() {
        currentIndex = (currentIndex - 1 + slides.length) % slides.length;
        updateSlider();
      }

      // Pausar o reanudar el slider
      function togglePause() {
        isPaused = !isPaused;
        const pauseIcon = pauseButton.querySelector('.pause-icon');
        const playIcon = pauseButton.querySelector('.play-icon');
        
        if (isPaused) {
          pauseIcon.style.display = 'none';
          playIcon.style.display = 'block';
        } else {
          pauseIcon.style.display = 'block';
          playIcon.style.display = 'none';
        }
      }

      // Evento para botones de control
      controlButtons.forEach((btn, index) => {
        btn.addEventListener('click', () => {
          currentIndex = index;
          updateSlider();
          resetInterval();
        });
      });

      // Eventos para botones de navegación
      if (prevButton) {
        prevButton.addEventListener('click', () => {
          prevSlideFunc();
          resetInterval();
        });
      }

      if (nextButton) {
        nextButton.addEventListener('click', () => {
          nextSlide();
          resetInterval();
        });
      }

      // Evento para botón de pausa
      if (pauseButton) {
        pauseButton.addEventListener('click', () => {
          togglePause();
        });
      }

      // Intervalo para auto-rotación de slides
      function startInterval() {
        if (autoplay && slides.length > 1) {
          slideInterval = setInterval(nextSlide, autoplaySpeed);
        }
      }

      function resetInterval() {
        clearInterval(slideInterval);
        startInterval();
      }

      // Iniciar slider
      updateSlider();
      startInterval();

      // Soporte táctil para móviles
      if (isMobile) {
        let touchStartX = 0;
        let touchEndX = 0;

        slider.addEventListener('touchstart', (e) => {
          touchStartX = e.changedTouches[0].screenX;
        }, false);

        slider.addEventListener('touchend', (e) => {
          touchEndX = e.changedTouches[0].screenX;
          handleGesture();
        }, false);

        function handleGesture() {
          const swipeThreshold = 50;
          const deltaX = touchEndX - touchStartX;
          if (Math.abs(deltaX) > swipeThreshold) {
            if (deltaX < 0) {
              nextSlide();
            } else {
              prevSlideFunc();
            }
            resetInterval();
          }
        }
      }
    }

    // Detectar dispositivo y mostrar el banner correspondiente
    function detectDevice() {
      const isMobile = window.innerWidth <= 768;
      const mobileContainer = document.querySelector('.body-movil-banner-principal');
      const desktopContainer = document.querySelector('.slider-container-banner-principal-body');
      
      if (mobileContainer) mobileContainer.style.display = isMobile ? 'flex' : 'none';
      if (desktopContainer) desktopContainer.style.display = isMobile ? 'none' : 'flex';
    }

    // Inicializar
    detectDevice();
    window.addEventListener('resize', detectDevice);

    // Inicializar slider para PC/Tablet
    initSlider({
      sliderSelector: `#slider-banner-principal-${sectionId}`,
      slideSelector: '.slide-banner-principal',
      controlButtonsSelector: '.control-button-banner-principal',
      prevButtonSelector: `#prev-banner-principal-${sectionId}`,
      nextButtonSelector: `#next-banner-principal-${sectionId}`,
      pauseButtonSelector: `#pause-banner-principal-${sectionId}`,
      isMobile: false
    });

    // Inicializar slider para Móvil
    initSlider({
      sliderSelector: `#slider-banner-principal-movil-${sectionId}`,
      slideSelector: '.slide-banner-principal-movil',
      controlButtonsSelector: '.control-button-banner-principal-movil',
      prevButtonSelector: `#prev-banner-principal-movil-${sectionId}`,
      nextButtonSelector: `#next-banner-principal-movil-${sectionId}`,
      pauseButtonSelector: `#pause-banner-principal-movil-${sectionId}`,
      isMobile: true
    });
  });
</script>

{% schema %}
{
  "name": "Banner Slider",
  "tag": "section",
  "class": "banner-slider-wrapper",
  "max_blocks": 10,
  "settings": [
    {
      "type": "select",
      "id": "page_width",
      "label": "Ancho de la sección",
      "options": [
        {
          "value": "full",
          "label": "Ancho completo"
        },
        {
          "value": "standard",
          "label": "Ancho estándar"
        }
      ],
      "default": "full"
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Reproducción automática",
      "default": true
    },
    {
      "type": "range",
      "id": "autoplay_speed",
      "label": "Velocidad de reproducción (segundos)",
      "min": 3,
      "max": 10,
      "step": 1,
      "default": 5
    }
  ],
  "blocks": [
    {
      "type": "slide",
      "name": "Banner",
      "settings": [
        {
          "type": "image_picker",
          "id": "image_desktop",
          "label": "Imagen Desktop (1400x400px recomendado)"
        },
        {
          "type": "image_picker",
          "id": "image_mobile",
          "label": "Imagen Móvil (800x800px recomendado)"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Enlace del banner"
        },
        {
          "type": "checkbox",
          "id": "open_new_tab",
          "label": "Abrir en nueva pestaña",
          "default": false
        },
        {
          "type": "text",
          "id": "title",
          "label": "Título del banner (para accesibilidad)"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Banner Slider",
      "blocks": [
        {
          "type": "slide"
        },
        {
          "type": "slide"
        },
        {
          "type": "slide"
        }
      ]
    }
  ]
}
{% endschema %}